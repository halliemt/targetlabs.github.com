<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8">
<title>
</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">
<!-- Le styles -->
<link href="assets/css/bootstrap.css" rel="stylesheet">
<style>
body { padding-top: 60px; /* 60px to make the container go all the way
                             to the bottom of the topbar */ }
</style>
<style>
#exclude-factors a.close {
  display: none;
}
#include-factors li, #exclude-factors li {
  margin: 0 5px 5px 5px; padding: 5px; width: 50%;
}
.drop-target {
  text-decoration: none;
  background-color: #eeeeee;
}
.dropdown-menu {
  cursor: pointer;
}
#demo-upload {
  margin: 5px;
}
</style>
<link href="assets/css/bootstrap-responsive.css" rel="stylesheet">
<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
<!--[if lt IE 9]>
<script src="http://html5shim.googlecode.com/svn/trunk/html5.js">
</script>
<![endif]-->
<link href="assets/css/bootstrap-wizard.css" rel="stylesheet" />
<style>
.wizard-modal.modal {
  margin-left: -600px;
}
</style>
<style>

.bar.positive {
  fill: green;
}

.bar.negative {
  fill: brown;
}

.axis text {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

</style>
<link href="assets/css/fineuploader-3.4.1.css" rel="stylesheet">
<style>
  /* Fine Uploader
  -------------------------------------------------- */
  .qq-upload-list {
    text-align: left;
  }

  /* For the bootstrapped demos */
  li.alert-success {
    background-color: #DFF0D8;
  }

  li.alert-error {
    background-color: #F2DEDE;
  }

  .alert-error .qq-upload-failed-text {
    display: inline;
  }

  .qq-upload-button {
    background-color: #5BB75B;
  }

  .qq-uploader {
    width: 250px;
  }
</style>
<style type="text/css">
  body {
    padding-top: 40px;
    padding-bottom: 40px;
    background-color: #f5f5f5;
  }

  .form-signin {
    max-width: 300px;
    padding: 19px 29px 29px;
    margin: 0 auto 20px;
    background-color: #fff;
    border: 1px solid #e5e5e5;
    -webkit-border-radius: 5px;
       -moz-border-radius: 5px;
            border-radius: 5px;
    -webkit-box-shadow: 0 1px 2px rgba(0,0,0,.05);
       -moz-box-shadow: 0 1px 2px rgba(0,0,0,.05);
            box-shadow: 0 1px 2px rgba(0,0,0,.05);
  }
  .form-signin .form-signin-heading,
  .form-signin .checkbox {
    margin-bottom: 10px;
  }
  .form-signin input[type="text"],
  .form-signin input[type="password"] {
    font-size: 16px;
    height: auto;
    margin-bottom: 15px;
    padding: 7px 9px;
  }

</style>

<link href="assets/css/nouislider.fox.css" rel="stylesheet">

<!-- Le fav and touch icons -->
<link rel="shortcut icon" href="assets/ico/favicon.ico">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="assets/ico/apple-touch-icon-144-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/ico/apple-touch-icon-114-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/ico/apple-touch-icon-72-precomposed.png">
<link rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-57-precomposed.png">
</head>

<body>
    <div class="container">

      <form class="form-signin">
        <h2 class="form-signin-heading">Please sign in</h2>
        <input type="text" class="input-block-level" placeholder="Email address">
        <input type="password" class="input-block-level" placeholder="Password">
        <label class="checkbox">
          <input type="checkbox" value="remember-me"> Remember me
        </label>
        <button class="btn btn-large btn-primary" type="submit">Sign in</button>
      </form>

    </div>

    <div class="wizard" id="support-model">
     
        <h1>The Target Labs</h1>
     
        <div class="wizard-card" data-cardname="upload">
            <h3>Upload</h3>
            <strong>Tell us what you want to do:</strong>
            <label class="radio">
              <input type="radio" name="modelType" value="support" checked>
              I want to make a support model
            </label>
            <label class="radio">
              <input type="radio" name="modelType" value="turnout">
              I want to make a turnout model
            </label>
            <label class="radio">
              <input type="radio" name="modelType" value="both">
              I want to make both a turnout and a support model
            </label>
     
            <hr>

            <strong>Here's what we'll need to make your model:</strong>
            <ul>
              <li>Voter file data on each individual voter in the district where your election is taking place (.csv format)</li>
              <li>Polling data containing responses from individual voters on whether they support your candidate or issue (.csv format)</li>
            </ul>
            <label class="radio">
              <input type="radio" name="dataFormat" checked id="dataFormatSingleFile">
              My polling data and my voter file data are both in one .csv file
            </label>
            <label class="radio">
              <input type="radio" name="dataFormat" id="dataFormatTwoFiles">
              My polling data and my voter file data are in different .csv files
            </label>
            <div id="bootstrapped-fine-uploader-combined-data"></div>
            <div id="bootstrapped-fine-uploader-separate-data" style="display:none">
              <div id="bootstrapped-fine-uploader-voter-data"></div>
              <div id="bootstrapped-fine-uploader-polling-data"></div>
              <br style="clear:both" />
              <label>voter data unique id:</label>
              <select id="voter-data-unique-id">
              </select>
              <label>polling data unique id:</label>
              <select id="polling-data-unique-id">
              </select>
            </div>
        </div>

        <div id="detail" class="wizard-card" data-cardname="detail">
            <h3>Data</h3>
            <div id="support-data">
            <div>
              <p>Which column in the file you uploaded contains information about whether the people you polled support you?</p>
              <div class="btn-group" id="support-field-select">
                <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">Choose column 
                  <span class="caret"></span>
                </a>
                <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                </ul>
              </div>
            </div>

            <hr>

            <div>
              <p>Which value within that column means that a voter supports you?</p>
              <div class="btn-group" id="support-value-select">
                <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">Choose value
                  <span class="caret"></span>
                </a>
                <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                </ul>
              </div>
            </div>
            </div>

            <hr>

            <div id="turnout-data" style="display:none;">
            <div>
              <p>Which column in the file you uploaded contains information about whether the people you polled will turn out?</p>
              <div class="btn-group" id="turnout-field-select">
                <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">Choose column 
                  <span class="caret"></span>
                </a>
                <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                </ul>
              </div>
            </div>

            <hr>

            <div>
              <p>Which value within that column means that a voter will turn out?</p>
              <div class="btn-group" id="turnout-value-select">
                <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">Choose value
                  <span class="caret"></span>
                </a>
                <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div id="factors" class="wizard-card" data-cardname="factors">
            <h3>Choose Predictors</h3>
            <p>We'll analyze the data in your file to find variables that help predict support for your issue or candidate.  Help us get started by sorting your data into categories.</p>

            <ul class="nav nav-tabs">
              <li class="active"><a href="#include-factors" data-toggle="tab">We'll test these for predictiveness</a></li>
              <li><a href="#exclude-factors" data-toggle="tab">We won't test these</a></li>
            </ul>
            <div class="tab-content">
              <div class="tab-pane active" id="include-factors">
                <h4>We'll test these for predictiveness</h4>
                <ul class="ui-helper-reset"></ul>
              </div>
              <div class="tab-pane" id="exclude-factors">
                <h4>Individual and household-level variables (we won't use these)</h4>
                <ul class="ui-helper-reset"></ul>
              </div>
            </div>
        </div>

        <div class="wizard-success">
            submission succeeded!
        </div>

        <div class="wizard-error">
            submission had an error
        </div>

        <div class="wizard-failure">
            submission failed
        </div>
    </div>
    <script src="assets/js/jquery-1.9.1.min.js"></script>
    <script src="assets/js/jquery-ui.js"></script>
    <script src="assets/js/jquery.csv-0.71.js"></script>
    <script src="assets/js/underscore.js"></script>
    <script src="assets/js/underscore.string.js"></script>
    <script src="assets/js/bootstrap.js"></script>
    <script src="assets/js/bootstrap-wizard.js" type="text/javascript"></script>
    <script src="assets/js/d3.v3.min.js" type="text/javascript"></script>
    <script src="assets/js/jquery.fineuploader-3.4.1.min.js"></script>
    <script src="assets/js/jquery.nouislider.min.js"></script>

    <script type="text/javascript">
    window.onerror = function(msg,url,lineNumber) {
        $.get('/error', {message: msg, url: url, lineNumber: lineNumber});
        return false;
    };
    </script>

    <script type="template/underscore" id="results-tpl">
      <h1>We've generated your model!</h1>
      <h2>Predictive Power: <%= gof %> - <% if(gof > 80) { print("Great!") } else { print("Poor") } %></h2>
      <h2>Size of Universe: <span id="nlikely"><%= likely %></span> (out of <%= total %>)</h2>
      <div class="pull-left">Score Cutoff: <input type="text" class="input-mini" disabled=disabled id="support-threshold"></input></div><div style="padding: 10px" class="pull-left"><div class="noUiSlider"></div></div>
      <div class="clearfix"></div>
      <p><a id="download-scores" class="btn btn-success" href="<%= link %>">Download scores</a></p>
      <div style="display: none;" id="scores-help">
        <p>Your voters' support scores will be in a new column on the far right.  Scores are on a scale of 0-1, where 1 means a high likelihood of support.</p>
        <img src="assets/img/scores_help.png">
      </div>
    </script>

    <script type="template/underscore" id="list-tpl">
      <li class="ui-state-default">
        <a class="close" href="#">&times;</a><span class="<%= type %>"><%= text %></span><% if(example) print(' ('+example+')') %>
      </li>
    </script>

    <script type="text/javascript">

    var TargetLabs = {};

    var list_tpl = _.template($("#list-tpl").text());
    var results_tpl = _.template($("#results-tpl").text());

    function onSlide(counts) {
        return function() {
            var threshold = $(this).val();
            total = _.reduce(counts, function(memo, value, index) {
                if(index >= threshold) {
                    return memo + value;
                } else {
                    return memo;
                }
            }, 0);
            $("#nlikely").text(total);
        }
    }

    function submit(wizard) {
        var $list = $("#include-factors li");
        var payload = {
              support_field: $("#support-field-select a.dropdown-toggle").text(),
              support_value: $("#support-value-select a.dropdown-toggle").text(),
              turnout_field: $("#turnout-field-select a.dropdown-toggle").text(),
              turnout_value: $("#turnout-value-select a.dropdown-toggle").text(),
              categorical: $list.find(".categorical").contents().map(function(i,e) { return $(e).text() }).toArray(),
              numbers: $list.find(".numeric").contents().map(function(i,e) { return $(e).text() }).toArray(),
              filenames: JSON.stringify({combined: (TargetLabs.combined||{}).filename, voter: (TargetLabs.voter||{}).filename, polling: (TargetLabs.polling||{}).filename}),
              uids: JSON.stringify({voter: $("#voter-data-unique-id").val(), polling: $("#polling-data-unique-id").val()}),
              type: modelType()
        };
        $.ajax({
            url: "/scores",
            type: "POST",
            data: payload,
            traditional: true,
            dataType: 'json',
            success: function(data, textStatus, jqXHR) {
                TargetLabs.response = data;
                $(".container").html(results_tpl({link: data.results, gof: data.gof, likely: data.nlikely, total: data.total}));
                var coef = _.omit(data.coefficients, 'Intercept')
                var chartdata = _.sortBy(_.map(coef, function(v,k) { return {name: k, value: v} }), function(d) { return -Math.abs(d.value)});
                drawChart(chartdata, ".container");
                $(".noUiSlider").noUiSlider({range: [0,1], step: 0.01, start: [0.5,1], handles: 2, slide: onSlide(data.counts), serialization: {to: [$("#support-threshold"), "support-max"]}});
                wizard.hide();
            },
            error: function() {
                wizard.submitError(); // display the error card
                wizard.hideButtons(); // hides the next and back buttons
            }
        });
    }

    function initWizard() {
        var options = {width: '1200px', increaseHeight: 200},
            wizard = $("#support-model").wizard(options);
        wizard.on('submit', submit);
        return wizard;
    }

    function populateAndWireUpFactors(factors) {

        $include = $("#include-factors ul");
        $exclude = $("#exclude-factors ul");

        var uniform_threshold = 0.6;
        var categorical_threshold = 10;

        $("#factors").on("click", "a.close", function() {
            $("#exclude-factors ul").append($(this).closest('li').remove());
        });

        var auto_reject = ['StreetNo', 'AptNo', 'Phone'];

        $.each(factors, function(header, factor) {
          var type = factor.numeric ? 'numeric' : 'categorical';

          if(factor.nunique == 1) {
            $exclude.append(list_tpl({text: header, example: _.isEmpty(factor.examples) ? 'no values' : factor.examples, type: type}));
          } else if(factor.nunique == factor.count) {
            $include.append(list_tpl({text: header, example: "", type: type}));
          } else if(factor.nunique / factor.count > uniform_threshold) {
            $include.append(list_tpl({text: header, example: "we think", type: type}));
          } else {
            var example_str = factor.examples.join(',');
            if(factor.nunique > 3) {
              example_str = example_str + ",...";
            }
            $include.append(list_tpl({text: header, example: example_str, type: type}));
          }
        });

        $("#include-factors ul, #exclude-factors ul").sortable().disableSelection();
        $("#factors .nav li").droppable({
          hoverClass: "drop-target",
          drop: function( event, ui ) {
            var $item = $( this );
            var $list = $( $item.find( "a" ).attr( "href" ) )
              .find( "ul" );

            ui.draggable.hide( "slow", function() {
              $item.find("a").tab("show");
              $( this ).appendTo( $list ).show( "slow" );
            });
          }
        });
    }

    function populateAndWireUpDetails(factors) {
        var $el = $("#support-field-select ul");
        var $next_el = $("#support-value-select ul");
        var $field_toggle = $("#support-field-select .dropdown-toggle");
        var $value_toggle = $("#support-value-select .dropdown-toggle");
        _populateAndWireUpDetails(factors, $el, $next_el, $field_toggle, $value_toggle);

        var $el = $("#turnout-field-select ul");
        var $next_el = $("#turnout-value-select ul");
        var $field_toggle = $("#turnout-field-select .dropdown-toggle");
        var $value_toggle = $("#turnout-value-select .dropdown-toggle");
        _populateAndWireUpDetails(factors, $el, $next_el, $field_toggle, $value_toggle);
    }

    function _populateAndWireUpDetails(factors, $el, $next_el, $field_toggle, $value_toggle) {
        $.each(factors, function(header) {
          $el.append($('<li>'+header+'</li>'));
        });

        $el.on('click', 'li', function(e) {
          var supportField = $(this).text();
          $field_toggle.text(supportField);
          $next_el.html(_.chain(factors[supportField].examples).map(function(line) { return $.trim(line); }).map(function(line) { return "<li>" + line + "</li>"; }).join("\n").value());
          $("#include-factors span:contains('"+supportField+"')").parent().find(".close").trigger("click");
        });

        $next_el.on('click', 'li', function(e) {
          var text = $(this).text();
          $value_toggle.text(text);
        });
    }

    function drawChart(data, container) {
        var margin = {top: 50, right: 10, bottom: 10, left: 100},
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        var x = d3.scale.linear()
            .range([0, width])

        var y = d3.scale.ordinal()
            .rangeRoundBands([0, height], .2);

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("top");

        var svg = d3.select(container).append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        x.domain(d3.extent(data, function(d) { return d.value; })).nice();
        y.domain(data.map(function(d) { return d.name; }));

        svg.selectAll(".label")
          .data(data)
          .enter()
          .append("svg:text")
          .text(function(d) { return d.name;})
          .attr("x", -100)
          .attr("y", function(d) { return y(d.name) + (y.rangeBand() / 2) + (this.getBBox().height / 2)});

        svg.selectAll(".bar")
            .data(data)
          .enter().append("rect")
            .attr("class", function(d) { return d.value < 0 ? "bar negative" : "bar positive"; })
            .attr("x", function(d) { return x(Math.min(0, d.value)); })
            .attr("y", function(d) { return y(d.name); })
            .attr("width", function(d) { return Math.abs(x(d.value) - x(0)); })
            .attr("height", y.rangeBand());

        svg.append("g")
            .attr("class", "x axis")
            .call(xAxis);

        svg.append("text")
            .attr("class", "x label")
            .attr("text-anchor", "middle")
            .attr("x", width / 2)
            .attr("y", -30)
            .text("Weight of variables in predicting outcome");

        svg.append("g")
            .attr("class", "y axis")
          .append("line")
            .attr("x1", x(0))
            .attr("x2", x(0))
            .attr("y2", height);
    }

    function createUploader(element, uploadText, dataType) {
      var uploader = new qq.FineUploader({
        element: element,
        request: {
          endpoint: '/upload',
          params: {dataType: dataType}
        },
        text: {
          uploadButton: '<div><i class="icon-upload icon-white"></i> '+uploadText+'</div>'
        },
        multiple: false,
        template: '<div class="qq-uploader span12">' +
                    '<pre class="qq-upload-drop-area span12"><span>{dragZoneText}</span></pre>' +
                    '<div class="qq-upload-button btn btn-success" style="width: auto">{uploadButtonText}</div>' +
                    '<span class="qq-drop-processing"><span>{dropProcessingText}</span><span class="qq-drop-processing-spinner"></span></span>' +
                    '<ul class="qq-upload-list" style="margin-top: 10px; text-align: center;"></ul>' +
                  '</div>',
        classes: {
          success: 'alert alert-success',
          fail: 'alert alert-error'
        },
        callbacks: {
          onComplete: uploadComplete
        }
      });
    }

    function uploadComplete(id, fileName, responseJSON) {
      var dataType = responseJSON.dataType || 'combined';
      TargetLabs[dataType] = TargetLabs[dataType] || {};
      TargetLabs[dataType].filename = fileName;
      TargetLabs[dataType].response = responseJSON;
      console.log(id, fileName, responseJSON);
      if (responseJSON.success) {
        try {
          var factors = responseJSON.factors;
          if (dataType === 'combined') {
            populateAndWireUpDetails(factors);
            populateAndWireUpFactors(factors);
          } else if (dataType === 'voter'){
            var $el = $("#voter-data-unique-id");
            $el.empty();
            $.each(factors, function(header) {
              $el.append("<option>"+header+"</option>");
            });
            populateAndWireUpFactors(factors);
          } else if (dataType === 'polling'){
            var $el = $("#polling-data-unique-id");
            $el.empty();
            $.each(factors, function(header) {
              $el.append("<option>"+header+"</option>");
            });
            populateAndWireUpDetails(factors);
          }
        } catch (e) {
          lasterror = e;
          console.log(e);
        }
      }
    }

    function prefillSupport(wizard) {
        $("#support-field-select .dropdown-toggle").text('marsupport');
        $("#support-value-select .dropdown-toggle").text('1');
    }

    createUploader(document.getElementById('bootstrapped-fine-uploader-combined-data'), 'Upload Voter and Polling Data', 'combined');
    createUploader(document.getElementById('bootstrapped-fine-uploader-voter-data'), 'Upload Voter Data', 'voter');
    createUploader(document.getElementById('bootstrapped-fine-uploader-polling-data'), 'Upload Polling Data', 'polling');

    $("#dataFormatTwoFiles").on("click", function() {
      $("#bootstrapped-fine-uploader-combined-data").hide();
      $("#bootstrapped-fine-uploader-separate-data").show(); 
    });
    $("#dataFormatSingleFile").on("click", function() {
      $("#bootstrapped-fine-uploader-separate-data").hide(); 
      $("#bootstrapped-fine-uploader-combined-data").show();
    });

    var wizard = initWizard();

    $(".form-signin button").on("click", function() { wizard.show(); return false; });
    $(".container").on("click", "#download-scores", function() { $("#scores-help").show() });

    function skipAhead(wizard) {
        $(".form-signin button").trigger("click");
        wizard._onNextClick();
        wizard._onNextClick();
        var $list = $("#include-factors li");
        $("a.dropdown-toggle", "#detail").first().text('marsupport');
        $("a.dropdown-toggle", "#detail").last().text('1');
        $("#include-factors ul").append(list_tpl({text: 'age', example: 'ex', type: 'numeric'}));
        $("#include-factors ul").append(list_tpl({text: 'sex', example: 'ex', type: 'categorical'}));
        $("#include-factors ul").append(list_tpl({text: 'party', example: 'ex', type: 'categorical'}));
        $("#include-factors ul").append(list_tpl({text: 'Ethnicity', example: 'ex', type: 'categorical'}));
        TargetLabs.filename = 'demo100.csv';
        submit(wizard);
    }

    function modelType() {
        return $("input[name=modelType]:checked").attr("value");
    }

    $(".form-signin button").trigger("click");
    $("#dataFormatTwoFiles").trigger("click");

    $("#demo-upload").on("click", function() {
        $.getJSON('/upload?filename=demo100.csv').then(function(data) {
            uploadComplete(null, 'demo100.csv', data);
        });
    });

    $("input[name=modelType]").on("click", function() {
        switch($(this).attr("value")) {
            case "both":
                $("#support-data, #turnout-data").show();
                break;
            case "turnout":
                $("#support-data").hide();
                $("#turnout-data").show();
                break;
            case "support":
                $("#turnout-data").hide();
                $("#support-data").show();
                break;
            default:
                console.log('default');
        }
    });
    </script>
</body>
</html>
